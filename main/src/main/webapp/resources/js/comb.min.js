/*2017-09-27 2:21 PM*/

var acctExpiredCtrlr=function($scope,$http,Upload){var today=new Date;$scope.reco={year:(new Date).getFullYear()},$scope.today=today.getFullYear()+"-"+(today.getMonth()+1)+"-"+today.getDate(),$scope.user={identifications:{recoExpiry:"",recomendation:""}},$scope.submitForm=function(){var proceed=!0;$scope.pageLevelAlert="",$(".recofile-group, .recoWrapper").removeClass("has-error"),$scope.invalidReco()&&(proceed=!1,$(".recoWrapper").addClass("has-error")),$scope.recoUploadForm.$valid&&$scope.recoFile&&proceed?$http.post(_lbUrls.recoreupload,$scope.user).then(function(response){var resp=response.data;resp.success?(localStorage.removeItem("recoFile"),location.href="/pending-verification"):$scope.pageLevelAlert=resp.message},function(){$scope.pageLevelAlert="There was some error creating your account. Please try later. If problem persists, please call the customer care."}):($scope.recoFile||$(".recofile-group").addClass("has-error"),$scope.recoUploadForm.$valid||($scope.pageLevelError="Please correct the highlighted sections"),$("html,body").scrollTop($(".has-error").offset().top-120))},$scope.removeFile=function(type){"reco"==type&&$scope.recoFile&&($http.post("/files/delete/id/"+$scope.recoFile._id),$scope.recoFile=null,localStorage.removeItem("recoFile"))},$scope.invalidReco=function(){if($scope.recoUploadForm.recoDay.$valid&&$scope.recoUploadForm.recoMonth.$valid&&$scope.recoUploadForm.recoYear.$valid){var now=new Date;if($scope.user.identifications.recoExpiry=new Date($scope.reco.year,$scope.reco.month-1,$scope.reco.day),$scope.user.identifications.recoExpiry.getTime()<now.getTime())return!0}return $scope.recoUploadForm.recoDay.$invalid&&!$scope.recoUploadForm.recoDay.$pristine||$scope.recoUploadForm.recoMonth.$invalid&&!$scope.recoUploadForm.recoMonth.$pristine||$scope.recoUploadForm.recoYear.$invalid&&!$scope.recoUploadForm.recoYear.$pristine},$scope.$watch("recofileobj",function(){new $scope.upload($scope.recofileobj,"reco")}),$scope.upload=function(file,type){if(file){var fileInfo={progress:!1,element:null};Upload.upload({url:"/files/upload",fields:{path:"/user/"+$scope.today+"/",ctrl:"controlled"},file:file,fileInfo:fileInfo}).then(function(resp){if(resp.config.fileInfo&&resp.config.fileInfo.element.closest(".row").remove(),resp.data.results){var img=resp.data.results[0];img&&type&&"reco"==type&&($scope.user.identifications.recomendation=img.location,$scope.recoFile=img,localStorage.setItem("recoFile",JSON.stringify(img)))}},function(resp){resp.config.fileInfo&&resp.config.fileInfo.element.parent().html('<div class="progress-bar progress-bar-danger"style="width: 100%">Error Uploading File</div>'),console.log("Error uploading the file")},function(evt){if(!evt.config.fileInfo.progress){var f=evt.config.fileInfo,container=".progress-wrapper ";type&&(container="."+type+"-progress-wrapper"),f.progress=!0,f.element=$("<div />").attr({class:"progress-bar progress-bar-success",role:"progressbar",style:"width:0%"}),$('<div class="row"><div class="col-xs-4 file-name-holder">'+evt.config.file.name+'</div><div class="col-xs-8"><div class="progress"></div></div>').appendTo(container).find(".progress").append(f.element)}if(evt.config.fileInfo){var progressPercentage=parseInt(100*evt.loaded/evt.total);evt.config.fileInfo.element.css("width",progressPercentage+"%").html(progressPercentage+"%")}})}},$scope.init=function(){try{$scope.user._id=$("#formUserId").val()}catch(e){}try{localStorage.getItem("recoFile")&&($scope.recoFile=JSON.parse(localStorage.getItem("recoFile")),$scope.user.identifications.recomendation=$scope.recoFile.location)}catch(e){}},$scope.init()},allProductCtrlr=function($scope,$http,$rootScope,$templateRequest,$compile,categoryFltrFilter){$scope.prices=[],$scope.productPrices={},$scope.currentPid=0,$scope._lbGlobalCDNPath=_lbGlobalCDNPath,$scope.flipBack=function(event){angular.element(event.target).closest("li").find(".product-item-card").removeClass("showInfo showOptions")},$scope.showInfo=function(event){angular.element(".product-item-card").removeClass("showInfo showOptions"),angular.element(event.target).closest("li").find(".product-item-card").addClass("showInfo")},$scope.showOptions=function(event){angular.element(".product-item-card").removeClass("showInfo showOptions");var $angularElement=angular.element(event.target).closest("li");$angularElement.find(".product-item-card").addClass("showOptions");var variation=$angularElement.data("var"),price=parseFloat($angularElement.data("p")),salePrice=parseFloat($angularElement.data("sp"));$scope.currentPid=$angularElement.data("pid"),$scope.angularListOn&&this.p&&(variation=this.p.variation,price=this.p.price,salePrice=this.p.salePrice,$scope.currentPid=this.p._id),0!==$scope.currentPid&&($scope.prices=[],$scope.productPrices[$scope.currentPid]||(variation?$http.get(_lbUrls.getprd+$scope.currentPid+"/price",{params:{hidepop:!0}}).then(function(resp){$scope.prices=resp.data,$scope.prices&&$scope.loadTemplate($angularElement)}):($scope.prices=[{_id:0,variationId:0,productId:$scope.currentPid,variation:[],stockCount:0,regPrice:price,salePrice:salePrice,stockStat:"instock",img:null,qty:0}],$scope.loadTemplate($angularElement))))},$scope.loadTemplate=function($angularElement){$templateRequest("productOptionsTemp").then(function(html){var template=angular.element(html);$angularElement.find(".product-options").removeClass("empty").empty().append(template),$compile(template)($scope)})},$scope.showBiggerImg=function(event){event.preventDefault();var $angularElement=angular.element(event.currentTarget),imgSrc=$angularElement.attr("href");$("#prodImgModal .modal-content").html($("<img />").attr({src:imgSrc,class:"fit"})),$("#prodImgModal").modal("show")},$scope.closeImgModal=function(){$("#prodImgModal").modal("hide")},$scope.setPageAlert=function(alert){$scope.pageLevelAlert=alert},$scope.angularListOn=!1,$scope.buildList={catFilter:"",order:"",orderTxt:"",role:""},$scope.orderAndOrderTxt=_lbConstants.productspage_orderAndOrderTxt,$scope.sortOrderChange=function(order){$scope.buildList.order=order,$scope.buildList.orderTxt=$scope.orderAndOrderTxt[order]};var scanListing=function(){$scope.buildList.products=[],$scope.buildList.order=$("#productSortMenu").data("order")?$("#productSortMenu").data("order"):"",$scope.buildList.orderTxt=$scope.orderAndOrderTxt[$scope.buildList.order],$scope.buildList.role=document.getElementById("lb_role_admin")?"admin":"",$("#thymeleaf-productlist>li").each(function(index){var p={},$e=$(this);p.name=$e.data("pname"),p.stockStat=$e.data("stockstat"),p._id=parseInt($e.data("pid")),p.featuredImg=$e.data("img"),p.variation=$e.data("var"),p.price=parseFloat($e.data("p")),p.salePrice=parseFloat($e.data("sp")),p.url=$e.data("url"),p.categories=$e.data("cat"),p.rating=parseInt($e.data("rating")),p.reviewCount=parseInt($e.data("review-count")),p.priceRange=$e.data("price-range"),p.description=$e.data("desc"),p.newBatchArrival=$e.data("newest"),p.productFilters={price:parseFloat($e.data("filter-price")),cbd:parseFloat($e.data("filter-cbd")),thc:parseFloat($e.data("filter-thc"))},$scope.buildList.products.push(p)}),reBuildListing()},reBuildListing=function(){$scope.buildList.products&&0!==$scope.buildList.products.length&&$templateRequest("productListTemplate").then(function(html){var template=angular.element(html);angular.element("#angular-productlist").empty().append(template),$compile(template)($scope),$scope.angularListOn=!0,$("#thymeleaf-productlist").hide(),$scope.productPrices={}})};scanListing()},categoryFilter=function(){return function(input,filter){if(!filter||""===$.trim(filter))return input;var out=[];return angular.forEach(input,function(product){product.categories&&product.categories.indexOf(filter)>-1&&out.push(product)}),out}},allProductPriceCtrlr=function($scope,$http,$rootScope,$timeout){$scope.itemTotal=0,$scope.calculateItemTotal=function(){$scope.itemTotal=0;for(var i=0;i<$scope.prices.length;i++){var curr=$scope.prices[i];0!==curr.qty&&(curr.salePrice?$scope.itemTotal+=curr.salePrice*curr.qty:$scope.itemTotal+=curr.regPrice*curr.qty)}},$scope.itemError="",$scope.itemSuccess="",$scope.quickAddToCart=function(event){$scope.itemError="",$scope.itemSuccess="";for(var $angularElement=angular.element(event.target).closest("li"),productName=$angularElement.data("pname"),productId=$angularElement.data("pid"),featuredImg=$angularElement.data("img"),lineItems=[],i=0;i<$scope.prices.length;i++){var curr=$scope.prices[i];0!==curr.qty&&lineItems.push({name:productName,qty:curr.qty,productId:productId,img:curr.img?curr.img:featuredImg,variationId:curr._id?curr._id:0})}return 0===lineItems.length?($scope.itemError="Please select quantity for atleast one item.",!1):($scope.addingToCart=!0,$scope.itemError="",$scope.itemSuccess="",$scope.$parent.setPageAlert(""),void $http.post(_lbUrls.addtocart+"/multi/?hidepop",lineItems).then(function(resp){if(resp.data&&resp.data.success){$scope.productInCart=resp.data.productCount,$rootScope.rootCartCount=resp.data.cartCount,$.cookie("lbbagnumber",resp.data.orderId,{expires:30,path:"/"}),$scope.itemSuccess="Item(s) added to cart.",$timeout(function(){$scope.itemSuccess=""},4e3);for(var i=0;i<$scope.prices.length;i++)$scope.prices[i].qty=0;$scope.itemTotal=0,$rootScope.$broadcast("mCartReload")}else $scope.itemError=resp.data.message;$scope.addingToCart=!1},function(resp){403==resp.status?$scope.$parent.setPageAlert("Your browser was idle for long. Please refresh the page and add the item to cart again."):$scope.$parent.setPageAlert("There was some error creating the order. Please try later. If problem persists, please call the customer care."),$scope.addingToCart=!1}))};var scopeInit=function(){$scope.prices=$scope.$parent.prices,$scope.prices.sort(function(a,b){return a.regPrice-b.regPrice});for(var itemsOutofStock=!0,i=0;i<$scope.prices.length;i++)$scope.prices[i].qty=0,"instock"==$scope.prices[i].stockStat&&(itemsOutofStock=!1);$scope.itemsOutofStock=itemsOutofStock,$scope.$parent.productPrices[$scope.$parent.currentPid]=$scope.prices,$scope.calculateItemTotal()};scopeInit()},cartCouponCtrlr=function($scope,$http,$rootScope){$scope.m},cartDeliveryCtrlr=function($scope,$http,$rootScope,$filter,$timeout){var m=$scope.m,addressApiInit=!1,getAddress=function(){return m.order.shipping.address.address1+" "+m.order.shipping.address.city+" "+m.order.shipping.address.state+" "+m.order.shipping.address.zip},getAddressMapLink=function(){if(m.order.shipping&&m.order.shipping.address){var mapLink={markers:"color:blue|label:S|"+getAddress(),zoom:17,scale:2,size:"280x280",center:getAddress(),key:"AIzaSyDOOuxNzzE247y4HbG9B5J2yM8vzzhegCU"};return"https://maps.googleapis.com/maps/api/staticmap?"+$.param(mapLink)}return null},addressLogic=function(){!m.order.shipping.address||""===m.order.shipping.address.address1&&""===m.order.shipping.address.city&&""===m.order.shipping.address.state&&""===m.order.shipping.address.zip||($scope.mainZip=m.order.shipping.address.zip,$scope.validateZip(!0))},proceedToPayment=function(){m.addressSaved=!0,$(".delivery-address").empty().append($("<img />").attr({src:getAddressMapLink(),class:"fit"})),m.codEnabled=!0,m.user&&m.user._id&&m.loadPaymentTemplate()},setUpDeliveryTimes=function(){if(m.emptyCart)return void console.log("setUpDeliveryTimes cancelled");var d=new Date,currHour=d.getHours(),timeTocheck=36e5;currHour>=23?(d.setDate(d.getDate()+1),$scope.deliveryTimeText="Tomorrow - "+$filter("date")(d,"mediumDate")+" after 11:00 AM PST",$scope.endTime=null):currHour<11?(currHour>10&&(timeTocheck=d.getMinutes()<30?9e5:6e4),$scope.deliveryTimeText="Today - "+$filter("date")(d,"mediumDate")+" after 11:00 AM PST",$scope.endTime=null):currHour>20?(timeTocheck=d.getMinutes()<30?9e5:6e4,d.setHours(22,29,0),$scope.endTime=d,$scope.deliveryTimeText="Today - "+$filter("date")(d,"mediumDate")):($scope.deliveryTimeText="Today - "+$filter("date")(d,"mediumDate"),$scope.endTime=null),$timeout(setUpDeliveryTimes,timeTocheck)},initAddressVars=function(){m.order.shipping||(m.order.shipping={}),m.order.shipping.address||(m.order.shipping.address={})};$scope.addressError="",$scope.deliveryOptionSelected=!0,$scope.deliveryEligible=!1,$scope.shippingEligible=!1,$scope.deliverySelected=!0,$scope.shippingSelected=!1,$scope.deliveryTimeText="",$scope.endTime=null,$scope.resetDeliveryOptions=function(){$scope.addressError="",$scope.invalidZip="",m.addressSaved=!1,m.destroyPaymentTemplate()},$scope.checkDeliveryOptions=function(){$scope.validateZip(),m.order.shipping&&m.order.shipping.address&&(m.order.shipping.address.zip=$scope.mainZip)},$scope.invalidZip="",$scope.validateZip=function(auto){$scope.resetDeliveryOptions(),$http.get(_lbUrls.cart+"/validatezip",{params:{zip:$scope.mainZip}}).then(function(resp){resp.data&&resp.data.success&&("both"==resp.data.message?($scope.deliveryEligible=!0,$scope.shippingEligible=!0,auto&&($scope.deliverySelected=!0,$scope.selectDeliveryOption())):"local"==resp.data.message?($scope.deliveryEligible=!0,auto&&($scope.deliverySelected=!0,$scope.selectDeliveryOption())):"shipping"==resp.data.message?($scope.shippingEligible=!0,auto&&($scope.shippingSelected=!0,$scope.selectDeliveryOption())):auto||($scope.invalidZip="Sorry, we currently don't service your area. We are working very hard on expanding to your city. "))},function(){$scope.invalidZip=$rootScope.errMsgPageRefresh})},$scope.selectDeliveryOption=function(){$scope.deliveryOptionSelected=!0,addressApiInit||$scope.mapsInit()},$scope.saveDeliveryAddress=function(){$scope.cartAddress.$valid&&($scope.addressError="",$scope.deliverySelected?m.order.shipping.deliveryMethod="Local Delivery":$scope.shippingSelected&&(m.order.shipping.deliveryMethod="Overnight Shipping"),$http.post(_lbUrls.cart+m.order._id+"/savedeliveryaddr",m.order.shipping).then(function(resp){resp.data&&resp.data.success?(_lbFns.pSuccess("Address Saved."),resp.data.message&&(m.order.shipping.deliveryMethod=resp.data.message,"Local Delivery"==resp.data.message?($scope.deliverySelected=!0,$scope.shippingSelected=!1):"Overnight Shipping"==resp.data.message&&($scope.shippingSelected=!0,$scope.deliverySelected=!1)),proceedToPayment()):resp.data&&resp.data.message?$scope.addressError=resp.data.message:$scope.addressError=$rootScope.errMsgPageRefresh},function(){$scope.addressError=$rootScope.errMsgPageRefresh}))},$scope.editAddress=function(){m.addressSaved=!1,$scope.showPayment=!1,$scope.cartAddress.$setDirty(),addressApiInit||$scope.mapsInit(),m.destroyPaymentTemplate()},$scope.saveDeliveryNotes=function(){m.order.notes||(m.order.notes={}),m.order.notes.deliveryNotes||(m.order.notes.deliveryNotes=""),m.order._id&&m.order.notes.deliveryNotes&&$http.post(_lbUrls.cart+m.order._id+"/savedeliverynote?hidepop",{deliveryNotes:m.order.notes.deliveryNotes})},$scope.gmapComponentForm={street_number:"short_name",route:"short_name",locality:"long_name",administrative_area_level_1:"short_name",postal_code:"short_name"},$scope.geolocate=function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(position){var geolocation={lat:position.coords.latitude,lng:position.coords.longitude},circle=new google.maps.Circle({center:geolocation,radius:position.coords.accuracy});$scope.autocomplete.setBounds(circle.getBounds())})},$scope.fillInAddress=function(){for(var place=$scope.autocomplete.getPlace(),streetNumber="",streetAddr="",i=0;i<place.address_components.length;i++){var addressType=place.address_components[i].types[0];if($scope.gmapComponentForm[addressType]){var val=place.address_components[i][$scope.gmapComponentForm[addressType]];switch(addressType){case"street_number":streetNumber=val;break;case"route":streetAddr=val;break;case"locality":m.order.shipping.address.city=val;break;case"administrative_area_level_1":m.order.shipping.address.state=val;break;case"postal_code":m.order.shipping.address.zip=val}}}m.order.shipping.address.address1=streetNumber?streetNumber+" "+streetAddr:streetAddr;try{$scope.$apply()}catch(err){}$("#cartAddress .form-control").each(function(){$(this).blur()})},$scope.mapsInit=function(){$scope.autocomplete=new google.maps.places.Autocomplete(document.getElementById("addressLocator"),{types:["geocode"],componentRestrictions:{country:"us"}}),$scope.autocomplete.addListener("place_changed",$scope.fillInAddress),$scope.geolocate(),initAddressVars(),addressApiInit=!0},function(){m.order&&m.order.shipping&&m.order.shipping.address&&(setUpDeliveryTimes(),addressLogic(),addressApiInit||$scope.mapsInit())}()},cartItemCtrlr=function($scope,$http,$rootScope,$timeout){$scope.itsOffHour=!1;var m=$scope.m,checkOffHours=function(){if(m.emptyCart)return void console.log("checkoffhours cancelled");var now=new Date,currHour=now.getHours(),currMin=now.getMinutes();22===currHour&&currMin>=29||currHour>=23||currHour<11?$scope.itsOffHour=!0:$scope.itsOffHour=!1,$timeout(checkOffHours,6e4)};checkOffHours(),$scope.itemRemove=function(){if($scope.$parent.$parent.pageLevelAlert="",m.order&&this.item){var req={method:"DELETE",url:_lbUrls.cart+"removeitem",params:{oid:m.order._id,pid:this.item.productId,vid:this.item.variationId}};$http(req).then(function(resp){resp.data&&resp.data.success?($rootScope.rootCartCount=resp.data.cartCount,m.order=resp.data.order,m.processOrder(),m.cartPage&&_lbFns.pSuccess("Item removed.")):resp.data&&resp.data.message?m.cartPage&&($scope.$parent.$parent.pageLevelAlert=resp.data.message):m.cartPage&&($scope.$parent.$parent.pageLevelAlert=$rootScope.errMsgPageRefresh)},function(){m.cartPage&&($scope.$parent.$parent.pageLevelAlert=$rootScope.errMsgPageRefresh)})}else m.cartPage&&($scope.$parent.$parent.pageLevelAlert=$rootScope.errMsgPageRefresh)},$scope.updateCart=function(per){if($scope.$parent.$parent.pageLevelAlert="",per&&parseInt(per)==per&&(this.item.qty=this.item.qty+parseInt(per)),this.item&&this.item.qty&&this.item.qty>0)$http.get(_lbUrls.cart+"updatecart",{params:{oid:m.order._id,vid:this.item.variationId,pid:this.item.productId,qty:this.item.qty}}).then(function(resp){resp.data&&resp.data.success?($rootScope.rootCartCount=resp.data.cartCount,m.order=resp.data.order,m.processOrder(),m.cartPage&&_lbFns.pSuccess("Order Updated.")):m.cartPage&&($scope.$parent.$parent.pageLevelAlert=resp.data.message)});else{if(!this.item.qty||this.item.qty<=0)return this.item.qty=1,!1;$scope.$parent.$parent.pageLevelAlert=$rootScope.errMsgPageRefresh}},$scope.qtyPlus=function(){this.item.qty++,$scope.updateCart.call(this)},$scope.qtyMinus=function(){this.item.qty--,this.item.qty<1&&(this.item.qty=1),$scope.updateCart.call(this)},$scope.addDoubleDown=function(){var pid=this.prd._id,vid=this.prd.vid;m.appliedCouponCode?removeCoupon(m.appliedCouponCode,function(){applyDoubleDown(pid,vid)}):applyDoubleDown(pid,vid)},$scope.addbriteBox=function(){m.appliedCouponCode?removeCoupon(m.appliedCouponCode,function(){applyBriteBox()}):applyBriteBox()},$scope.addFifthFlower=function(){m.appliedCouponCode?removeCoupon(m.appliedCouponCode,function(){applyFifthFlower()}):applyFifthFlower()};var applyDoubleDown=function(pid,vid){$http.post(_lbUrls.cart+"/adddoubledown/"+pid+"/"+vid).then(function(resp){resp.data&&resp.data.success?($rootScope.rootCartCount=resp.data.cartCount,m.order=resp.data.order,m.processOrder(),_lbFns.pSuccess("Offer Item Added.")):$scope.$parent.$parent.pageLevelAlert=$rootScope.errMsgPageRefresh},function(resp){403==resp.status?$scope.$parent.$parent.pageLevelAlert="Your browser was idle for long. Please refresh the page and add the item to cart again.":$scope.$parent.$parent.pageLevelAlert="There was some error adding the item. Please try later. If problem persists, please call the customer care."})},applyBriteBox=function(){$http.post(_lbUrls.cart+"/addbritebox").then(function(resp){resp.data&&resp.data.success?($rootScope.rootCartCount=resp.data.cartCount,m.order=resp.data.order,m.processOrder(),_lbFns.pSuccess("Brite Box Item Added.")):$scope.$parent.$parent.pageLevelAlert=$rootScope.errMsgPageRefresh},function(resp){403==resp.status?$scope.$parent.$parent.pageLevelAlert="Your browser was idle for long. Please refresh the page and add the item to cart again.":$scope.$parent.$parent.pageLevelAlert="There was some error adding the item. Please try later. If problem persists, please call the customer care."})},applyFifthFlower=function(){$http.post(_lbUrls.cart+"/add-assorted-variety").then(function(resp){resp.data&&resp.data.success?($rootScope.rootCartCount=resp.data.cartCount,m.order=resp.data.order,m.processOrder(),_lbFns.pSuccess("Holiday offer item added.")):$scope.$parent.$parent.pageLevelAlert=$rootScope.errMsgPageRefresh},function(resp){403==resp.status?$scope.$parent.$parent.pageLevelAlert="Your browser was idle for long. Please refresh the page and add the item to cart again.":$scope.$parent.$parent.pageLevelAlert="There was some error adding the item. Please try later. If problem persists, please call the customer care."})},removeCoupon=function(couponCode,cb){$scope.couponErrors="",couponCode?$http.get(_lbUrls.cart+"removecoupon/"+couponCode,{params:{hidepop:!0,oid:m.order._id}}).then(function(resp){resp.data&&resp.data.success?(_lbFns.pSuccess("Promocode removed"),m.order=resp.data.order,m.processOrder(),fixAvailableCoupons(),cb&&cb()):resp.data&&resp.data.message?$scope.couponErrors=resp.data.message:$scope.couponErrors=$rootScope.errMsgPageRefresh},function(){$scope.couponErrors=$rootScope.errMsgPageRefresh}):$scope.couponErrors="Invalid promo code"};$scope.prdCartClose=function(){$("body").removeClass("sidecartOpen").addClass("sidecartClose")},$scope.couponErrors="",$scope.removeCoupon=function(){removeCoupon(this.item.name,null)},$scope.applyCoupon=function(){$scope.couponErrors="",m.couponCode?$http.get(_lbUrls.cart+"applycoupon/"+m.couponCode,{params:{hidepop:!0,oid:m.order._id}}).then(function(resp){resp.data&&resp.data.success?(_lbFns.pSuccess("Promocode applied"),m.couponCode="",m.order=resp.data.order,m.processOrder(),fixAvailableCoupons()):resp.data&&resp.data.message?$scope.couponErrors=resp.data.message:$scope.couponErrors="Invalid promo code"},function(){$scope.couponErrors=$rootScope.errMsgPageRefresh}):$scope.couponErrors="Invalid promo code"},$scope.clearCouponErrorMsg=function(){$scope.couponErrors=""},$scope.useThisCoupon=function(){this.promo&&(m.couponCode=this.promo,$scope.applyCoupon())},$scope.allPromos=[],$scope.promos=[];var fixAvailableCoupons=function(){if($scope.promos=$scope.allPromos.slice(),m.order.lineItems)for(var i=0;i<m.order.lineItems.length;i++){var item=m.order.lineItems[i];if("coupon"==item.type)for(var j=0;j<$scope.promos.length;j++)if($scope.promos[j]==item.name){$scope.promos.splice(j,1);break}}0===$scope.promos.length?m.promosAvailable=!1:m.promosAvailable=!0},getCustomerCoupons=function(){m.promosAvailable=!1,$http.get(_lbUrls.cart+"getcpromos",{params:{hidepop:!0}}).then(function(resp){resp.data&&resp.data.success?(m.promosAvailable=!0,$scope.allPromos=resp.data.results,fixAvailableCoupons()):$scope.promos=[]},function(){$scope.promos=[]})};m.user&&m.user._id&&getCustomerCoupons(),$(document).on("click",".cart-promo-options .fa-label",function(){if(0!==$(".cart-promo-options.promoSelected").length){var x=$(".cart-promo-options.promoSelected").offset().top,offset=parseInt($(".header-offset").css("margin-top"));$("html, body").animate({scrollTop:x-offset},400)}})},cartMainCtrlr=function($scope,$http,$templateRequest,$compile,$rootScope){var m=this,deliveryLoaded=!1,cmcVersion=Math.random();m.order={},m.ddprds=[],m.user={},m.orderMin=9999,m.config={},m.sales=[],m.cartPage=!1,m.cartLoading=!0,m.pmtCOD=!1,m.cartData=null,m.ccErrors="",m.promoOptions="",m.couponCode="",$scope.pageLevelAlert="",_globalUserId&&(m.user._id=_globalUserId),m.promosAvailable=!1,m.couponApplied=!0,m.appliedCouponCode="",m.offersApplied=!1,m.offersOtherThanProductSaleApplied=!1,m.orderAboveOrderMin=!1,m.emptyCart=!0,m.addressSaved=!1,m.codEnabled=!0,m.ccPmtEnabled=!1,m.doubleDownActive=!1,m.doubleDownApplied=!1,m.doubleDownEligible=!1,m.flowerCount=0,m.flowerIds=[],m.fifthFlowerActive=!1,m.fifthFlowerApplied=!1,m.fifthFlowerEligible=!1,m.briteBoxApplied=!1,m.briteBoxEligible=!1,m.briteBoxThreshold=75,m.availableDeals={},m.showPromoTab=!0,m.valentinePromoActive=!1,m.valentinePromoApplied=!1,m.freeGramPromo=!0,m.freeGramPromoApplied=!1,m.freeGramPromoEligible=!1,m.freeGramPromoMin=150,m.processOrder=function(){m.sales=[],m.appliedCouponCode="",m.promoOptions="";var couponApplied=!1,offersApplied=!1,doubleDownApplied=!1,briteBoxApplied=!1,fifthFlowerApplied=!1,offersOtherThanProductSaleApplied=!1,emptyCart=!0,flowerCount=0;if(m.order.lineItems&&m.order.lineItems.length>0&&m.order.lineItems.forEach(function(item){if(item.instock&&("item"==item.type&&(emptyCart=!1,item.img&&(item.img=item.img.replace(".jpg","-150x150.jpg")),10504!=item.productId&&11871!=item.productId&&m.flowerIds.indexOf(item.productId)>-1&&(flowerCount+=item.qty),11839!=item.productId&&11871!=item.productId&&11939!=item.productId&&11951!=item.productId||(item.notEditable=!0)),"coupon"==item.type&&(couponApplied=!0,m.appliedCouponCode=item.name),item.promo&&""!==item.promo&&(offersApplied=!0,"s"!=item.promo&&(offersOtherThanProductSaleApplied=!0)),"item"==item.type&&("s"==item.promo||"doubledownoffer"==item.promo||"firsttimepatient"==item.promo||"freepowerpuff"==item.promo))){var productName=item.name,discount=(item.cost-item.price)*item.qty;"doubledownoffer"==item.promo?(productName="Double Down Offer",doubleDownApplied=!0):"firsttimepatient"==item.promo?(productName="First Time Patient",briteBoxApplied=!0):"freepowerpuff"==item.promo&&(productName="Power Puff Roll Promo"),!isNaN(discount)&&discount>0&&m.sales.push({name:productName,price:discount})}}),m.doubleDownApplied=doubleDownApplied,m.couponApplied=couponApplied,m.offersApplied=offersApplied,m.offersOtherThanProductSaleApplied=offersOtherThanProductSaleApplied,m.emptyCart=emptyCart,m.briteBoxApplied=briteBoxApplied,m.fifthFlowerApplied=fifthFlowerApplied,m.flowerCount=flowerCount,m.order.total&&(m.order.total>=m.orderMin||m.user&&(29==m.user._id||1==m.user._id))?(m.orderAboveOrderMin=!0,m.cartPage&&!deliveryLoaded&&m.loadDeliveryTemplate()):(m.orderAboveOrderMin=!1,m.cartPage&&m.destroyDeliveryTemplate()),m.doubleDownActive&&!m.doubleDownApplied?m.doubleDownEligible=!0:m.doubleDownEligible=!1,m.availableDeals.firstTimepatient&&!m.briteBoxApplied?m.briteBoxEligible=!0:m.briteBoxEligible=!1,m.freeGramPromoApplied=!1,m.freeGramPromoEligible=!1,m.freeGramPromo&&m.order.total&&m.order.total>=m.freeGramPromoMin&&(m.freeGramPromoEligible=!0,m.offersOtherThanProductSaleApplied||(m.freeGramPromoApplied=!0)),m.briteBoxApplied?m.showPromoTab=!1:m.briteBoxEligible&&m.order.total>=m.briteBoxThreshold||m.doubleDownEligible&&m.order.total>=m.config.doubleDown||m.fifthFlowerActive&&!m.fifthFlowerApplied&&m.flowerCount>=4||m.promosAvailable&&!m.couponApplied||!m.couponApplied?m.showPromoTab=!0:m.showPromoTab=!1,!m.briteBoxApplied&&m.availableDeals.firstTimepatient?m.promoOptions="firsttimepatient":m.fifthFlowerActive&&!m.fifthFlowerApplied&&m.flowerCount>=4?m.promoOptions="fifthflower":m.doubleDownEligible&&m.order.total>=m.config.doubleDown?m.promoOptions="doubledown":m.promosAvailable?m.promoOptions="loyalist":m.couponApplied||(m.promoOptions="coupon"),m.cartPage&&m.emptyCart&&m.destroyItemTemplate(),m.fifthFlowerApplied&&m.flowerCount<4&&m.order&&m.order._id){var req={method:"DELETE",url:_lbUrls.cart+"removeitem",params:{oid:m.order._id,pid:11871,vid:0}};$http(req).then(function(resp){resp.data&&resp.data.success&&($rootScope.rootCartCount=resp.data.cartCount,m.order=resp.data.order,m.processOrder())})}m.valentinePromoApplied=!1,m.valentinePromoActive&&m.order.total>=120&&(m.valentinePromoApplied=!0,m.sales.push({name:"Valentines day promotion",price:13}),m.order.subTotal+=13)},m.getCart=function(){$http.get(_lbUrls.getcart,{params:{hidepop:!0}}).then(function(resp){m.cartLoading=!1,m.order=resp.data.order,m.user=resp.data.user?resp.data.user:{},resp.data.config&&(m.config=resp.data.config,m.config.orderMinimum&&m.config.orderMinimum>0&&(m.orderMin=m.config.orderMinimum),m.config.doubleDown&&m.config.doubleDown>0&&resp.data.ddPrds&&resp.data.ddPrds.length>0&&(m.doubleDownActive=!0,m.ddprds=resp.data.ddPrds)),resp.data.availableDeals&&(m.availableDeals=resp.data.availableDeals),resp.data.commonList&&m.fifthFlowerActive&&(m.flowerIds=resp.data.commonList),m.order&&m.processOrder(),m.cartPage&&!m.emptyCart?(m.loadItemTemplate(),m.loadCouponTemplate()):m.emptyCart||m.cartPage?m.emptyCart&&!m.cartPage&&$("body").hasClass(".sidecartOpen")&&$("body").removeClass("sidecartOpen").addClass("sidecartClose"):$("body").removeClass("sidecartClose").addClass("sidecartOpen")},function(){m.cartLoading=!1})},angular.element(".cartPage").size()>0&&(m.cartPage=!0),m.getCart(),$scope.$on("mCartReload",function(){m.getCart()}),m.loadItemTemplate=function(){$scope.ivm=$scope.$new(),$templateRequest("/resources/ng-templates/cart/item.html?"+cmcVersion).then(function(html){var template=angular.element(html);angular.element("#itemCtrlr").append(template),$compile(template)($scope.ivm)})},m.destroyItemTemplate=function(){$scope.ivm&&$scope.ivm.$destroy(),angular.element("#itemCtrlr").empty(),m.destroyDeliveryTemplate(),m.destroyCouponTemplate()},m.loadCouponTemplate=function(){$scope.cvm=$scope.$new(),$templateRequest("/resources/ng-templates/cart/coupon.html?"+cmcVersion).then(function(html){var template=angular.element(html);angular.element("#couponCtrlr").append(template),$compile(template)($scope.cvm)})},m.destroyCouponTemplate=function(){$scope.cvm&&$scope.cvm.$destroy(),angular.element("#couponCtrlr").empty()},m.loadDeliveryTemplate=function(){$scope.dvm=$scope.$new(),$templateRequest("/resources/ng-templates/cart/delivery.html?"+cmcVersion).then(function(html){var template=angular.element(html);angular.element("#deliveryCtrlr").append(template),$compile(template)($scope.dvm),deliveryLoaded=!0})},m.destroyDeliveryTemplate=function(){$scope.dvm&&$scope.dvm.$destroy(),angular.element("#deliveryCtrlr").empty(),deliveryLoaded=!1,m.destroyPaymentTemplate(),m.addressSaved=!1},m.loadPaymentTemplate=function(){$scope.pvm=$scope.$new(),$templateRequest("/resources/ng-templates/cart/payment.html?"+cmcVersion).then(function(html){var template=angular.element(html);angular.element("#paymentCtrlr").append(template),$compile(template)($scope.pvm)})},m.destroyPaymentTemplate=function(){$scope.pvm&&$scope.pvm.$destroy(),angular.element("#paymentCtrlr").empty();try{m.paymentForm&&m.paymentForm.destroy()}catch(e){console.log(e)}m.cardData=null,m.ccErrors="",m.destroyReviewTemplate()},m.loadReviewTemplate=function(){$scope.rvm=$scope.$new(),$templateRequest("/resources/ng-templates/cart/review.html?"+cmcVersion).then(function(html){var template=angular.element(html);angular.element("#reviewCtrlr").append(template),$compile(template)($scope.rvm),$("html,body").animate({scrollTop:$(window).scrollTop()+250},500)})},m.destroyReviewTemplate=function(){$scope.rvm&&$scope.rvm.$destroy(),angular.element("#reviewCtrlr").empty()}},cartPaymentCtrlr=function($scope,$http,$rootScope,$timeout){var m=$scope.m,pmtApiInit=!1;$scope.nonceRequesting=!1,$scope.pmtChangable=!0,$scope.pmtMethod=null,$scope.reviewLoaded=!1,m.cardNonceResponseReceived=function(errors,nonce,cardData){errors?(m.ccErrors="",errors.forEach(function(error){m.ccErrors+=error.message})):(m.cardData=cardData,m.cardData.nonce=nonce,$scope.proceedToReview()),$scope.nonceRequesting=!1;try{$scope.$apply()}catch(err){}},m.unsupportedBrowserDetected=function(){m.ccErrors="Sorry, Your browser doesn't support the secure processing of this credit card. Please try a different browser.",$scope.nonceRequesting=!1;try{$scope.$apply()}catch(err){}},m.paymentForm=new SqPaymentForm({applicationId:"sq0idp-uKKHToPW2VxvmD6WKutvHA",inputClass:"form-control",inputStyles:[{fontSize:"14px",color:"#555"}],cardNumber:{elementId:"sq-card-number",placeholder:"---- ---- ---- ----"
},cvv:{elementId:"sq-cvv",placeholder:"CVV"},expirationDate:{elementId:"sq-expiration-date",placeholder:"MM/YY"},postalCode:{elementId:"sq-postal-code"},callbacks:{cardNonceResponseReceived:m.cardNonceResponseReceived,unsupportedBrowserDetected:m.unsupportedBrowserDetected,inputEventReceived:function(inputEvent){switch(inputEvent.eventType){case"focusClassAdded":break;case"focusClassRemoved":break;case"errorClassAdded":break;case"errorClassRemoved":break;case"cardBrandChanged":break;case"postalCodeChanged":}}}}),$scope.reqCardNonce=function(){m.ccErrors="",m.cardData=null,$scope.nonceRequesting=!0,m.paymentForm.requestCardNonce()},$scope.squareUpInit=function(){if(!pmtApiInit){try{m.paymentForm.build()}catch(e){console.log(e)}$timeout(function(){m.paymentForm.setPostalCode(m.order.shipping.address.zip)},1e3),pmtApiInit=!0}},$scope.proceedToReview=function(){"cod"==$scope.pmtMethod?m.pmtCOD=!0:m.pmtCOD=!1,m.order.billing||(m.order.billing={}),m.order.billing.pmtMethod||(m.order.billing.pmtMethod={}),m.order.billing.pmtMethod.method=$scope.pmtMethod,"cc"==$scope.pmtMethod?m.order.billing.pmtMethod.type="Credit Card":"cod"==$scope.pmtMethod&&(m.order.billing.pmtMethod.type="Donation on Delivery"),m.order.billing.pmtMethod.cardData=null,m.cardData&&(m.order.billing.pmtMethod.cardData=m.cardData),m.loadReviewTemplate(),$scope.reviewLoaded=!0},$scope.clearReview=function(){m.destroyReviewTemplate(),$scope.reviewLoaded=!1},function(){m.codEnabled?m.ccPmtEnabled||($scope.pmtMethod="cod",$scope.pmtChangable=!1):($scope.pmtMethod="cc",$scope.pmtChangable=!1,$scope.squareUpInit())}()},cartReviewCtrlr=function($scope,$http,$rootScope){var m=$scope.m;$scope.reviewErrors="",$scope.placeOrder=function(){m.order._id&&m.user._id?(m.ccErrors="",$scope.reviewErrors="",$http.post(_lbUrls.cart+m.order._id+"/placeorder",m.order).then(function(resp){resp&&resp.data?resp.data.success?location.href="/confirmation/"+resp.data.message:resp.data.paymentProcessed||""===resp.data.paymentError?resp.data.paymentProcessed&&resp.data.orderFinalizationError?$scope.reviewErrors="Your payment was processed successfully. But there was some error finializing the order. Please don't place the order again. Please call our customer care. Error details -  "+resp.data.message:$scope.reviewErrors=resp.data.message:("retry"==resp.data.message?m.ccErrors="Payment request timed out, please try again.":m.ccErrors=resp.data.paymentError,m.cardData="",m.destroyReviewTemplate()):$scope.reviewErrors="There was error placing the order. Please refresh the page and try again later. If problem persists, please contact customer care."},function(){$scope.reviewErrors=$rootScope.errMsgPageRefresh})):$scope.reviewErrors="Unable to find an order. Are you sure you have items in your cart and you are logged in to your account?"},$scope.scrollToPromo=function(){var x=$(".avaliablepromos-tab").offset().top,offset=parseInt($(".header-offset").css("margin-top"));$("html, body").animate({scrollTop:x-offset},400)}},homeCtrlr=function($scope,$http,$rootScope){$scope.fiveGramSpecials=[],$scope.successMsg="",$scope.errorMsg="",$scope.get5gms=function(){$http.get(_lbUrls.getprd+"get5gspecials",{params:{hidepop:!0}}).then(function(resp){$scope.fiveGramSpecials=resp.data})},$scope.get5gms()},localBoxCtrlr=function($scope,$http,$rootScope){$scope.quantity=1,$scope.successMsg="",$scope.errorMsg="",$scope.addingToCart=!1,$scope.addToCart=function(){return $scope.errorMsg="",$scope.successMsg="",!$scope.quantity||$scope.quantity<=0?($scope.errorMsg="Minimum quantity should be 1.",!1):($scope.addingToCart=!0,$scope.lineItem={name:"Localbox",qty:$scope.quantity,productId:11823,img:"/uploads/2016/07/localbox.jpg",variationId:0},void $http.post(_lbUrls.addtocart+"?hidepop",$scope.lineItem).then(function(resp){resp.data&&resp.data.success?($scope.productInCart=resp.data.productCount,$rootScope.rootCartCount=resp.data.cartCount,$.cookie("lbbagnumber",resp.data.orderId,{expires:30,path:"/"}),$scope.successMsg="Item added to cart."):$scope.errorMsg=resp.data.message,$scope.addingToCart=!1},function(resp){403==resp.status?$scope.errorMsg="Your browser was idle for long. Please refresh the page and add the item to cart again.":$scope.errorMsg="There was some error creating the order. Please try later. If problem persists, please call the customer care.",$scope.addingToCart=!1}))}},loginCtrlr=function($scope,$http){$scope.user={},$scope.login=function(){var req={method:"POST",url:_lbUrls.login,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{username:$scope.user.username,password:$scope.user.password,rememberme:!0}};return $http(req).then(function(resp){resp.data?resp.data.pending?location.href=resp.data.pending:resp.data.expired?location.href=resp.data.expired:resp.data.success?""!==$("#redirectURL").val()?location.href=$("#redirectURL").val():location.href=resp.data.success:resp.data.authfailure?$scope.pageLevelAlert=resp.data.authfailure:$scope.pageLevelAlert="There was some error. Please try again later.":$scope.pageLevelAlert="There was some error. Please try again later."},function(){$scope.pageLevelAlert="There was some error. Please try again later."}),!1}},productCtrlr=function($scope,$http,$rootScope){$scope.prices=[],$scope.productId=$("#productId").val(),$scope.productSelected={},$scope.outofstock=!1,$scope.productStockStat=$("#productStockStat").val(),$scope.featuredImg=$("#featuredImg").val(),$scope.variableProduct=!!document.getElementById("variableProduct"),$scope.addingToCart=!1,$scope.quantity=1,$scope.successMsg="",$scope.productInCart=0,$scope.lineItem={},$scope.getProductPrice=function(){$http.get(_lbUrls.getprd+$scope.productId+"/price",{params:{hidepop:!0}}).then(function(resp){if($scope.prices=resp.data,$scope.prices){$scope.outofstock=!0,$scope.prices.sort(function(a,b){return a.regPrice-b.regPrice});for(var i=0;i<$scope.prices.length;i++)if("instock"==$scope.prices[i].stockStat){$scope.prices[i].selected=!0,$scope.productSelected=$scope.prices[i],$scope.outofstock=!1;break}"outofstock"==$scope.productStockStat&&($scope.prices.forEach(function(e){e.selected=!1,e.stockStat="outofstock"}),$scope.outofstock=!0)}})},$scope.selectPrdOption=function(){if("outofstock"!=this.price.stockStat)if($scope.prices.forEach(function(e){e.selected=!1}),this.price.selected=!0,$scope.productSelected=this.price,$scope.productSelected.img&&"null"!=$scope.productSelected.img)$scope.zoomFn.destroy(),$img.find("img").attr("src","/files/view/"+$scope.productSelected.img),$img.data("variationImg",!0),$scope.zoomFn.activate();else{if(!$img.data("variationImg"))return;$scope.zoomFn.destroy(),$img.find("img").attr("src","/files/view/"+$scope.featuredImg),$img.data("variationImg",!1),$scope.zoomFn.activate()}},$scope.addToCart=function(){return $scope.errorMsg="",$scope.successMsg="",$scope.variableProduct&&!$scope.productSelected?($scope.errorMsg="Please select a product.",!1):!$scope.quantity||$scope.quantity<=0?($scope.errorMsg="Minimum quantity should be 1.",!1):($scope.addingToCart=!0,$scope.lineItem={name:$("#productName").val(),qty:$scope.quantity,productId:$scope.productId,img:$scope.productSelected.img?$scope.productSelected.img:$scope.featuredImg,variationId:$scope.productSelected._id?$scope.productSelected._id:0},void $http.post(_lbUrls.addtocart+"?hidepop",$scope.lineItem).then(function(resp){resp.data&&resp.data.success?($scope.productInCart=resp.data.productCount,$rootScope.rootCartCount=resp.data.cartCount,$.cookie("lbbagnumber",resp.data.orderId,{expires:30,path:"/"}),$scope.successMsg="Item added to cart."):$scope.errorMsg=resp.data.message,$scope.addingToCart=!1},function(resp){403==resp.status?$scope.errorMsg="Your browser was idle for long. Please refresh the page and add the item to cart again.":$scope.errorMsg="There was some error creating the order. Please try later. If problem persists, please call the customer care.",$scope.addingToCart=!1}))},$scope.getProductsInCart=function(){$http.get(_lbUrls.cart+"productInCart",{params:{pid:$scope.productId,hidepop:!0}}).then(function(resp){resp.data.success&&($scope.productInCart=resp.data.message)})},$scope.productId&&($scope.variableProduct?$scope.getProductPrice():"instock"!=$scope.productStockStat&&($scope.outofstock=!0),"instock"==$scope.productStockStat&&$scope.getProductsInCart()),$scope.changeMainImg=function($event){var $currLi=$($event.target).closest("li");if(!$currLi.hasClass("selected")){$scope.zoomFn.destroy();var newImg=$currLi.find("img"),newImgSrc=newImg.data("zoom")?newImg.data("zoom").replace(".jpg","-600x600.jpg"):"",videoEmbed=newImg.data("video-embed")?newImg.data("video-embed"):"",$mainImg=$(".prdpage-img img");""!==newImgSrc&&($mainImg.attr("src",newImgSrc),$mainImg.data("zoom",newImg.data("zoom")),$currLi.addClass("selected").siblings().removeClass("selected"),""!==videoEmbed?($mainImg.data("video-embed",videoEmbed),$mainImg.addClass("videoEmbed")):($mainImg.data("video-embed",null),$mainImg.removeClass("videoEmbed"),$scope.zoomFn.activate()))}},$scope.showReviews=!1,$scope.reviews=[],$scope.reviewSortIsOpen=!1,$scope.reviewSortOptions=[{text:"Sort by - Most recent reviews",value:"latest"},{text:"Sort by - Oldest reviews",value:"old"},{text:"Sort by - Most rated reviews",value:"toprated"},{text:"Sort by - Lowest rated reviews",value:"lowrated"}],$scope.reviewSortSelected=$scope.reviewSortOptions[0],$scope.getProductReviews=function(){$http.get(_lbUrls.getprd+$scope.productId+"/topreviews",{params:{s:$scope.reviewSortSelected.value,hidepop:!0}}).then(function(resp){$scope.reviews=resp.data})},$scope.changeReviewSort=function(){$scope.reviewSortSelected=this.rso,$scope.getProductReviews()},$scope.toggleDropdown=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.reviewSortIsOpen=!$scope.reviewSortIsOpen},function(){$("#productReviewsIndicator").length>0&&($scope.showReviews=!0,$scope.getProductReviews())}(),$scope.zoomFn={activate:function(){var $imgWarpper=$(".prdpage-img"),url=$imgWarpper.find("img").data("zoom");url&&""!==url&&$imgWarpper.zoom({url:url,callback:function(){$(this).parent().addClass("loaded")}})},destroy:function(){$(".prdpage-img").removeClass("loaded").trigger("zoom.destroy")}},$scope.zoomFn.activate()},registerCtrlr=function($scope,$http,Upload){var today=new Date;$scope.user={identifications:{},marketing:{}},$scope.reco={year:(new Date).getFullYear()},$scope.dob={},$scope.today=today.getFullYear()+"-"+(today.getMonth()+1)+"-"+today.getDate(),$scope.hearAboutOptions=["WeedMaps","Yelp","Facebook","Leafly","Friends & Family","La Weekly","Other"],$scope.register=function(){var proceed=!0;$scope.pageLevelAlert="",$(".recofile-group, .idfile-group, .dobWrapper, .recoWrapper").removeClass("has-error"),$scope.invalidDob()&&(proceed=!1,$(".dobWrapper").addClass("has-error")),$scope.invalidReco()&&(proceed=!1,$(".recoWrapper").addClass("has-error")),$scope.registerForm.$valid&&$scope.recoFile&&$scope.idFile&&proceed?$http.post(_lbUrls.register,$scope.user).then(function(response){var resp=response.data;resp.success?(localStorage.removeItem("recoFile"),localStorage.removeItem("idFile"),location.href="/pending-registration"):$scope.pageLevelAlert=resp.message},function(){$scope.pageLevelAlert="There was some error creating your account. Please try later. If problem persists, please call the customer care."}):($scope.recoFile||$(".recofile-group").addClass("has-error"),$scope.idFile||$(".idfile-group").addClass("has-error"),$scope.registerForm.$valid||($scope.pageLevelError="Please correct the highlighted sections"),$("html,body").scrollTop($(".has-error").offset().top-120))},$scope.removeFile=function(type){"id"==type&&$scope.idFile?($http.post("/files/delete/id/"+$scope.idFile._id),$scope.idFile=null,localStorage.removeItem("idFile")):"reco"==type&&$scope.recoFile&&($http.post("/files/delete/id/"+$scope.recoFile._id),$scope.recoFile=null,localStorage.removeItem("recoFile"))},$scope.invalidFname=function(){return $scope.registerForm.firstname.$invalid&&!$scope.registerForm.firstname.$pristine},$scope.invalidLname=function(){return $scope.registerForm.lastname.$invalid&&!$scope.registerForm.lastname.$pristine},$scope.invalidEmail=function(){return $scope.registerForm.email.$invalid&&!$scope.registerForm.email.$pristine},$scope.invalidUname=function(){return $scope.registerForm.username.$invalid&&!$scope.registerForm.username.$pristine},$scope.invalidPassword=function(){return $scope.registerForm.password.$invalid&&!$scope.registerForm.password.$pristine},$scope.invalidCPassword=function(){return!$scope.registerForm.confirmpassword.$pristine&&$scope.user.password!=$scope.confirmPassword},$scope.invalidPhone=function(){return $scope.registerForm.phone.$invalid&&!$scope.registerForm.phone.$pristine},$scope.invalidDob=function(){if($scope.registerForm.dobDay.$valid&&$scope.registerForm.dobMonth.$valid&&$scope.registerForm.dobYear.$valid){var now=new Date,currYear=now.getFullYear(),year21Before=currYear-21;if(now.setFullYear(year21Before),$scope.user.dob=new Date($scope.dob.year,$scope.dob.month-1,$scope.dob.day),$scope.user.dob.getTime()>now.getTime())return!0}return $scope.registerForm.dobDay.$invalid&&!$scope.registerForm.dobDay.$pristine||$scope.registerForm.dobMonth.$invalid&&!$scope.registerForm.dobMonth.$pristine||$scope.registerForm.dobYear.$invalid&&!$scope.registerForm.dobYear.$pristine},$scope.invalidReco=function(){if($scope.registerForm.recoDay.$valid&&$scope.registerForm.recoMonth.$valid&&$scope.registerForm.recoYear.$valid){var now=new Date;if($scope.user.identifications.recoExpiry=new Date($scope.reco.year,$scope.reco.month-1,$scope.reco.day),$scope.user.identifications.recoExpiry.getTime()<now.getTime())return!0}return $scope.registerForm.recoDay.$invalid&&!$scope.registerForm.recoDay.$pristine||$scope.registerForm.recoMonth.$invalid&&!$scope.registerForm.recoMonth.$pristine||$scope.registerForm.recoYear.$invalid&&!$scope.registerForm.recoYear.$pristine},$scope.$watch("idfileobj",function(){new $scope.upload($scope.idfileobj,"id")}),$scope.$watch("recofileobj",function(){new $scope.upload($scope.recofileobj,"reco")}),$scope.upload=function(file,type){if(file){var fileInfo={progress:!1,element:null};Upload.upload({url:"/files/upload",fields:{path:"/user/"+$scope.today+"/",ctrl:"controlled"},file:file,fileInfo:fileInfo}).then(function(resp){if(resp.config.fileInfo&&resp.config.fileInfo.element.closest(".row").remove(),resp.data.results){var img=resp.data.results[0];img&&(type&&"id"==type?($scope.user.identifications.idCard=img.location,$scope.idFile=img,localStorage.setItem("idFile",JSON.stringify(img))):type&&"reco"==type&&($scope.user.identifications.recomendation=img.location,$scope.recoFile=img,localStorage.setItem("recoFile",JSON.stringify(img))))}},function(resp){resp.config.fileInfo&&resp.config.fileInfo.element.parent().html('<div class="progress-bar progress-bar-danger"style="width: 100%">Error Uploading File</div>'),console.log("Error uploading the file")},function(evt){if(!evt.config.fileInfo.progress){var f=evt.config.fileInfo,container=".progress-wrapper ";type&&(container="."+type+"-progress-wrapper"),f.progress=!0,f.element=$("<div />").attr({class:"progress-bar progress-bar-success",role:"progressbar",style:"width:0%"}),$('<div class="row"><div class="col-xs-4 file-name-holder">'+evt.config.file.name+'</div><div class="col-xs-8"><div class="progress"></div></div>').appendTo(container).find(".progress").append(f.element)}if(evt.config.fileInfo){var progressPercentage=parseInt(100*evt.loaded/evt.total);evt.config.fileInfo.element.css("width",progressPercentage+"%").html(progressPercentage+"%")}})}},$scope.init=function(){try{localStorage.getItem("recoFile")&&($scope.recoFile=JSON.parse(localStorage.getItem("recoFile")),$scope.user.identifications.recomendation=$scope.recoFile.location),localStorage.getItem("idFile")&&($scope.idFile=JSON.parse(localStorage.getItem("idFile")),$scope.user.identifications.idCard=$scope.idFile.location)}catch(e){}},$scope.init()},resetCtlr=function($scope,$http,$rootScope){$scope.successNotification="",$scope.invalidPassword=function(){return $scope.resetRequest.password.$invalid&&!$scope.resetRequest.password.$pristine},$scope.invalidCPassword=function(){return!$scope.resetRequest.cpassword.$pristine&&$scope.password!=$scope.cpassword},$scope.requestReset=function(){""!==$scope.emailUsername?$http.get(_lbUrls.creset,{params:{u:$scope.emailUsername}}).then(function(response){var resp=response.data;resp.success?$scope.successNotification="We have emailed the password reset link to your registered email address":$scope.pageLevelAlert=resp.message},function(){$scope.pageLevelAlert=$rootScope.errMsgContactSupport}):$scope.pageLevelAlert="Please provide username or email to reset your password."},$scope.changePassword=function(){""!==$scope.password&&$scope.password==$scope.cpassword?$http.post(_lbUrls.rsavep,{username:$("#formusername").val(),email:$("#formemail").val(),password:$scope.password}).then(function(response){var resp=response.data;resp.success?$scope.successNotification="Password changed successfully":$scope.pageLevelAlert=resp.message},function(){$scope.pageLevelAlert=$rootScope.errMsgContactSupport}):""===$scope.password?$scope.pageLevelAlert="Please provide valid passwords":$scope.password!=$scope.cpassword&&($scope.pageLevelAlert="Passwords don't match")}},_d2dMaskZindex=9999,_lbPNotices=!1,_lbUSStates=[{name:"Alabama",code:"AL"},{name:"Alaska",code:"AK"},{name:"American Samoa",code:"AS"},{name:"Arizona",code:"AZ"},{name:"Arkansas",code:"AR"},{name:"California",code:"CA"},{name:"Colorado",code:"CO"},{name:"Connecticut",code:"CT"},{name:"Delaware",code:"DE"},{name:"District Of Columbia",code:"DC"},{name:"Federated States Of Micronesia",code:"FM"},{name:"Florida",code:"FL"},{name:"Georgia",code:"GA"},{name:"Guam",code:"GU"},{name:"Hawaii",code:"HI"},{name:"Idaho",code:"ID"},{name:"Illinois",code:"IL"},{name:"Indiana",code:"IN"},{name:"Iowa",code:"IA"},{name:"Kansas",code:"KS"},{name:"Kentucky",code:"KY"},{name:"Louisiana",code:"LA"},{name:"Maine",code:"ME"},{name:"Marshall Islands",code:"MH"},{name:"Maryland",code:"MD"},{name:"Massachusetts",code:"MA"},{name:"Michigan",code:"MI"},{name:"Minnesota",code:"MN"},{name:"Mississippi",code:"MS"},{name:"Missouri",code:"MO"},{name:"Montana",code:"MT"},{name:"Nebraska",code:"NE"},{name:"Nevada",code:"NV"},{name:"New Hampshire",code:"NH"},{name:"New Jersey",code:"NJ"},{name:"New Mexico",code:"NM"},{name:"New York",code:"NY"},{name:"North Carolina",code:"NC"},{name:"North Dakota",code:"ND"},{name:"Northern Mariana Islands",code:"MP"},{name:"Ohio",code:"OH"},{name:"Oklahoma",code:"OK"},{name:"Oregon",code:"OR"},{name:"Palau",code:"PW"},{name:"Pennsylvania",code:"PA"},{name:"Puerto Rico",code:"PR"},{name:"Rhode Island",code:"RI"},{name:"South Carolina",code:"SC"},{name:"South Dakota",code:"SD"},{name:"Tennessee",code:"TN"},{name:"Texas",code:"TX"},{name:"Utah",code:"UT"},{name:"Vermont",code:"VT"},{name:"Virgin Islands",code:"VI"},{name:"Virginia",code:"VA"},{name:"Washington",code:"WA"},{name:"West Virginia",code:"WV"},{name:"Wisconsin",code:"WI"},{name:"Wyoming",code:"WY"}],_lbStackBottomRight={dir1:"up",dir2:"left",firstpos1:25,firstpos2:25},_lbFns={showBusy:function(){return $('<div class="fix lboverlay" style="z-index:'+_d2dMaskZindex++ +'"><span class="lb_busy_pop abs">Processing...</span></div>').appendTo("body")},showViewForm:function(){$(".view-edit-form").css("background-color","#ffc").delay(2e3).queue(function(){$(this).css("background-color","transparent"),$(this).dequeue()})},navOffsetCorrection:function(){},showToTop:function(){$(window).scrollTop()>100?$(".to-top").is(":hidden")&&$(".to-top").fadeIn(300):$(".to-top").is(":visible")&&$(".to-top").fadeOut(300)},goToTop:function(){return $("html, body").animate({scrollTop:0},200),!1},ratingFunction:function(){return $(this).is(":checked")&&$(this).parent().addClass("checked").siblings().removeClass("checked"),!1},activateNavMenu:function(elem){$("."+elem).addClass("active").siblings().removeClass("active")},playModalVideo:function(){var videoEmbed=$(this).data("video-embed");videoEmbed&&($("#videoPlayerModal .modal-content").html(videoEmbed),$("#videoPlayerModal").modal())},closeVideoModal:function(){$("#videoPlayerModal").modal("hide").find(".modal-content").html("")},pAlert:function(msg,title,callBack,showCancel){var options={title:"Oops!",text:"There was some error processing your request. Please try later.",type:"error",buttons:{sticker:!1},hide:!1,addclass:"pnotifyNoCancel"};msg&&(options.text=msg),title&&(options.title=title),callBack&&(options.buttons.closer=!1,showCancel&&(options.addclass=""),options.confirm={confirm:!0,align:"center",buttons:[{text:"OK",click:function(n){callBack(n)}},{addClass:"btnCancel"}]}),new PNotify(options)},pWarn:function(msg,title,callBack){_lbPNotices&&_lbPNotices.remove();var options={title:"Are you sure?",text:"You want to proceed.",type:"notice",buttons:{sticker:!1,closer:!1},hide:!1,addclass:"pnotifyWarn"};msg&&(options.text=msg),title&&(options.title=title),options.confirm={confirm:!0,align:"center",buttons:[{text:"Yes",click:function(n){n.remove(),callBack(!0)}},{text:"No",addClass:"lmarg3",click:function(n){n.remove(),callBack(!1)}}]},_lbPNotices=new PNotify(options)},pInfo:function(msg,delay,bottom){var options={text:"Success",type:"info",buttons:{sticker:!1}};void 0===delay||null===delay?options.delay=5e3:0===delay?options.hide=!1:options.delay=delay,msg&&(options.text=msg),bottom&&(options.addclass="stack-bottomright",options.stack=_lbStackBottomRight),new PNotify(options)},pSuccess:function(msg,delay,bottom){var options={text:"Success",type:"success",buttons:{sticker:!1}};void 0===delay||null===delay?options.delay=5e3:0===delay?options.hide=!1:options.delay=delay,msg&&(options.text=msg),bottom&&(options.addclass="stack-bottomright",options.stack=_lbStackBottomRight),new PNotify(options)}},_lbUrls={addtocart:"/cart/add",getprd:"/products/json/",allprds:"/products/json/prod-cat",catprds:"/category/listproducts/",getcartcount:"/cart/getCount",getcart:"/cart/getcart",cart:"/cart/",login:"/login",register:"/register",creset:"/createreset",rsavep:"/reset/savep",recoreupload:"/reco-reupload"},_lbConstants={productspage_orderAndOrderTxt:{"-newBatchArrival":"Newest","productFilters.price":"Lowest Price","-productFilters.price":"Highest Price","-rating":"Highly rated","-reviewCount":"Most reviews","-productFilters.thc":"High THC","-productFilters.cbd":"High CBD"}};$(document).ready(function(){_lbFns.navOffsetCorrection(),$(window).scroll(_lbFns.showToTop).resize(_lbFns.navOffsetCorrection),$("body").on("click",".to-top",_lbFns.goToTop).on("click",".videoEmbed",_lbFns.playModalVideo).on("change",".rate input",_lbFns.ratingFunction),PNotify.prototype.options.styling="fontawesome"});var appRunFns=function($http,$rootScope,$interval){$rootScope.errMsgPageRefresh="There was some error processing your request. Please refresh the page and try again.",$rootScope.errMsgContactSupport="There was some error processing your request. Please refresh the page and try again. If problem persists, please contact support.",$http.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",$rootScope.$on("ajax-start",function(){_lbFns.showBusy()}),$rootScope.$on("ajax-stop",function(){$("div.lboverlay").remove()}),$rootScope.lbGlobalCDNPath=_lbGlobalCDNPath;var cookieVal=$.cookie("above21");cookieVal||0!==$("#noLbDisclaimer").size()?$(".footer-disclaimer").remove():$(".footer-disclaimer").addClass("present"),$rootScope.saveDisclaimerSession=function(){$.cookie("above21","accepted",{expires:60,path:"/"}),$(".footer-disclaimer").animate({opacity:0},1e3,function(){$(this).remove()})};var rootPrevValue=$("#_lb_sec_tok").val();csrfCorrection=$interval(function(){$http.get("/check?hidepop").then(function(resp){var x=resp.data;$("#_lb_sec_tok").val(x.message),rootPrevValue!=x.message&&($.cookie("XSRF-TOKEN",x.message,{path:"/"}),rootPrevValue=x.message)},function(){angular.isDefined(csrfCorrection)&&$interval.cancel(csrfCorrection)})},3e5),$rootScope.rootCartCount=0,$rootScope.$on("updateCartCount",function(){$http.get(_lbUrls.getcartcount,{params:{hidepop:!0}}).success(function(data){$rootScope.rootCartCount=data.cartCount})}),$(".header-cart").size()>0&&$rootScope.$broadcast("updateCartCount"),$rootScope.formElemValidate=function(event){var $elm=angular.element(event.target),y=$elm.data("$ngModelController");y&&(y.$invalid&&!y.$pristine?$elm.parents(".form-group").addClass("has-error"):$elm.parents(".form-group").removeClass("has-error"))},$rootScope.gSearch="",$rootScope.showGlobalSearch=function(){$rootScope.gSearch="",$(".nav-search").slideDown(300,function(){$(this).find("input").focus()})},$rootScope.hideGlobalSearch=function(){$(".nav-search").fadeOut(300)}},appConfigs=function($httpProvider){$httpProvider.interceptors.push(function($q,$rootScope){function show(config){if(!requests)try{config&&(config.url.indexOf("/upload")>-1||config.url.indexOf("hidepop")>-1||config.params.hidepop)||$rootScope.$broadcast("ajax-start")}catch(e){$rootScope.$broadcast("ajax-start")}requests++}function hide(){requests--,requests||$rootScope.$broadcast("ajax-stop")}var requests=0;return{request:function(config){return show(config),$q.when(config)},response:function(response){return hide(),$q.when(response)},responseError:function(rejection){return hide(),$q.reject(rejection)}}})},remainingTime=function($interval){return function(scope,element,attrs){function clearTime(){element.text(""),$interval.cancel(stopTime)}function updateTime(){if(null!==endTime){var now=(new Date).getTime(),et=endTime.getTime();if(et-now>0){var mils=et-now,seconds=Math.floor(mils/1e3%60),minutes=Math.floor(mils/6e4%60),hours=Math.floor(mils/36e5%24),display="";hours>0&&(display+=hours+"h "),display+=minutes+"m "+seconds+"s",element.text(" (If you order in "+display+")")}else element.text("Sorry you are past the cutt off time."),$interval.cancel(stopTime)}}var stopTime,endTime=null;scope.$watch(attrs.remainingTime,function(value){value?(endTime=value,updateTime()):clearTime()}),stopTime=$interval(updateTime,1e3),element.on("$destroy",function(){$interval.cancel(stopTime)})}},lbApp=angular.module("lbApp",["ngAnimate","ngSanitize","ui.bootstrap","ngFileUpload"]).config(["$httpProvider",appConfigs]).run(["$http","$rootScope","$interval",appRunFns]).controller("allProductCtrlr",["$scope","$http","$rootScope","$templateRequest","$compile","categoryFltrFilter",allProductCtrlr]).controller("allProductPriceCtrlr",["$scope","$http","$rootScope","$timeout",allProductPriceCtrlr]).controller("productCtrlr",["$scope","$http","$rootScope",productCtrlr]).controller("loginCtrlr",["$scope","$http",loginCtrlr]).controller("registerCtrlr",["$scope","$http","Upload",registerCtrlr]).controller("resetCtlr",["$scope","$http","$rootScope",resetCtlr]).controller("cartMainCtrlr",["$scope","$http","$templateRequest","$compile","$rootScope",cartMainCtrlr]).controller("cartItemCtrlr",["$scope","$http","$rootScope","$timeout",cartItemCtrlr]).controller("cartDeliveryCtrlr",["$scope","$http","$rootScope","$filter","$timeout",cartDeliveryCtrlr]).controller("cartPaymentCtrlr",["$scope","$http","$rootScope","$timeout",cartPaymentCtrlr]).controller("cartCouponCtrlr",["$scope","$http","$rootScope",cartCouponCtrlr]).controller("cartReviewCtrlr",["$scope","$http","$rootScope",cartReviewCtrlr]).controller("localBoxCtrlr",["$scope","$http","$rootScope",localBoxCtrlr]).controller("homeCtrlr",["$scope","$http","$rootScope",homeCtrlr]).controller("acctExpiredCtrlr",["$scope","$http","Upload",acctExpiredCtrlr]).directive("remainingTime",["$interval",remainingTime]).filter("categoryFltr",categoryFilter);
//# sourceMappingURL=comb.min.js.map